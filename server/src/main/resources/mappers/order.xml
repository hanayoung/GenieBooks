<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- name space는 BookRepo의 fully qualified name으로 설정한다. -->
<mapper namespace="com.ssafy.cafe.model.dao.OrderDao">
	<insert id="insert" parameterType="Order" 
	               useGeneratedKeys="true" keyProperty="id">
		INSERT INTO p_customer
			(c_id)
		VALUES
			(#{userId})
	</insert>

<!--r-->

	<select id="selectByUser" parameterType="int" resultType="Order">
		SELECT
            o_id as id
             , c_id as user_id
             , o_date as order_time
             , is_done as completed
        FROM p_customer where c_id=#{userId}
        order by o_id desc
	</select>


    <select id="selectOrderDetails" parameterType="int" resultMap="OrderResult">
        select
            o_id as id
            , c_id as user_id
            , o_date as order_time
            , is_done as completed
        from p_customer

        where o_id = #{id};
    </select>



    <!-- 관통 프로젝트 6단계에서 추가됨 -->
    <select id="getLastMonthOrder" parameterType="string" resultType="Order">
        select
            o_id,
            c_id,
            o_date,
            is_done
        from p_customer

        where o_id = #{id} and order_time > date_add(now(), interval -1 month)
        order by o_id desc
    </select>

    <select id="getOrderDetail" parameterType="int" resultType="OrderDetail">
       select
            c.o_id as order_id
            , b.isbn as isbn
            , b.quantity as quantity
        from p_customer c
        join p_book b on c.o_id = b.o_id
    </select>

    <resultMap id="OrderResult" type="Order">
        <collection property="details" javaType="List" column="id" ofType="OrderDetail"
         select="getOrderDetail"/>
    </resultMap>

</mapper>